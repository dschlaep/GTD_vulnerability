################### CALCULATE SHIFTS, MASKS, AND ATTRIBUTION ######
#
# Daniel Schlaepfer, 2015-2016
# 
# Calculate study area, shifts, ranks, and attribution to shifts
# Scripts '5a2_GTD_*.R' and '5a3_GTD_*.R' must be run before data can be loaded with '5a1_GTD_*.R'
#	- 'done_precalculations' will be stored as flag indicate whether this script has successfully completed
#	- requests 'get_data_extraction' from '5a1_GTD_*.R'
#
###################################################################



#---GLOBAL SETTINGS
comp <- "dropbox"

#-------------------------------

#---Load data and misc. functions
if (comp %in% c("err", "eleos")) {
	dir.gtd <- "/PATH_TO_PROJECT/Product_PowellCenter/6_Projects_Year1"
} else if (comp == "dropbox") {
	dir.gtd <- "/PATH_TO_PROJECT/Product_PowellCenter/6_Projects_Year1"
}
dir.prj <- file.path(dir.gtd, "Prj03_GlobalVulnerability", "4_Analysis", "4_Analysis_v4")

get_data_extraction <- TRUE
source(file.path(dir.prj, "5a1_GTD_Prj03v4_Helper.R"))

stopifnot(done_data_extraction)

dir.create(dir.out_PC <- file.path(dir.sim_out, "PreCalculations"), showWarnings = FALSE)
dir.create(dir.fig_PC <- file.path(dir.prj, "6_Results", "1_StudyArea"), showWarnings = FALSE)



#-------------------------------
#---CALCULATE MORE NARROWLY DEFINED STUDY AREA

if (!file.exists(ftemp <- file.path(dir.out_PC, paste0("dStudy2_", tag_dbScen, ".RData")))) {
# str(data): num [1:2, 1:3, 1:17, 1:20021] 1 1 1 NA 1 NA 1 NA 1 1 ...
# - attr(*, "dimnames") = List of 4
# ..$ : chr [1:2] "MetDef_Any33Cond" "MetDef_ThisCond"
# ..$ : chr [1:3] "Current" "RCP45" "RCP85"
# ..$ : chr [1:17] "Current" "CanESM2" "CESM1-CAM5" "CSIRO-Mk3-6-0" ...
# ..$ : NULL
	dStudy2 <- dMAT0 <- dAI005 <- dAI05 <- dSand90 <- dD <- array(NA, dim = dim(dStudy), dimnames = dimnames(dStudy))

	#---Calculate criteria
	#"MetDef_ThisCond" based on resXXX["Simulation", ...], i.e., not yet subset to any study area definition!
	for (ircp in seq_along(reqRCPs_wCur)) {
		for (igcm in seq_along(reqGCMs_wCur)) {
			dMAT0["MetDef_ThisCond", ircp, igcm, ] <- ifelse(resDefinition["Simulation", ircp, igcm, , "MAT_C_mean"] > 0, 1, NA)
			dAI005["MetDef_ThisCond", ircp, igcm, ] <- ifelse(resDefinition["Simulation", ircp, igcm, , "UNAridityIndex_Normals_none_mean"] > 0.05, 1, NA)
			dAI05["MetDef_ThisCond", ircp, igcm, ] <- ifelse(resDefinition["Simulation", ircp, igcm, , "UNAridityIndex_Normals_none_mean"] <= 0.5, 1, NA)
			dSand90["MetDef_ThisCond", ircp, igcm, ] <- ifelse(resSoils["Simulation", ircp, igcm, , "SWinput_Soil_topLayers_Sand_fraction"] < 0.9, 1, NA)
			dD["MetDef_ThisCond", ircp, igcm, ] <- ifelse(resDefinition["Simulation", ircp, igcm, , "TrewarthaD_Normals_TF_mean"] == 1, 1, NA)
		}
	}
	
	#---Add "MetDef_Any17Cond" information (for sake of completeness)
	dMAT0 <- get_Any17Cond_v4(data = dMAT0)
	dAI005 <- get_Any17Cond_v4(data = dAI005)
	dAI05 <- get_Any17Cond_v4(data = dAI05)
	dSand90 <- get_Any17Cond_v4(data = dSand90)
	dD <- get_Any17Cond_v4(data = dD)
	
	
	#---Apply criteria to calculate new study area
	temp <- dMAT0["MetDef_ThisCond", , , ] * dAI005["MetDef_ThisCond", , , ] * dAI05["MetDef_ThisCond", , , ] * dSand90["MetDef_ThisCond", , , ] * dD["MetDef_ThisCond", , , ]
	stopifnot(identical(dStudy["MetDef_ThisCond", , , ] * temp, temp))
	dStudy2["MetDef_ThisCond", , , ] <- temp

	#--- Cells that are in study area 2 at least under one of the 17 climate conditions per RCP (i.e., "MetDef_Any17Cond")
	dStudy2 <- get_Any17Cond_v4(data = dStudy2)
	print(paste("Cells ('MetDef_Any17Cond', 'RCP45')", sum(!is.na(dStudy2["MetDef_Any17Cond", "RCP45", currentSc, ])))) # XX; XX cells were eliminated due to dMAT0, dAI005, dAI05 and dSand90 compared to the 11510 cells of dStudy
	print(paste("Cells ('MetDef_Any17Cond', 'RCP85')", sum(!is.na(dStudy2["MetDef_Any17Cond", "RCP85", currentSc, ])))) # XX; XX cells were eliminated due to dMAT0, dAI005, dAI05 and dSand90 compared to the 12593 cells of dStudy

	temp <- test_coherence_among_study_areas(data = dStudy2)
	stopifnot(nrow(temp) == 0)	

	if (FALSE) {
		#inputs
		ia <- 1; ircp <- 3; igcm <- 2
		plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = dStudy2[ia, 2, 2,])
		points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, col = adjustcolor("red", alpha.f = 0.4)[dStudy2[ia, 3, 2,]])

		ltemp <- cut(resDefinition[1 + ia, ircp, igcm, , "MAT_C_mean"], breaks = c(-Inf, 0, 5, 10, 15, Inf))
		print(levels(ltemp))
		cols <- c("blue", heat.colors(n = nlevels(ltemp)-1))
		points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, col = cols[ltemp])

		ltemp <- cut(resDefinition[1 + ia, ircp, igcm, , "UNAridityIndex_Normals_none_mean"], breaks = c(0, 0.05, 0.2, 0.5, 0.65, Inf))
		print(levels(ltemp))
		cols <- c("blue", "green", heat.colors(n = nlevels(ltemp)-2))
		points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, col = cols[ltemp])

		ltemp <- cut(resSoils[1 + ia, 1, 1, , "SWinput_Soil_topLayers_Sand_fraction"], breaks = c(0, 0.2, 0.5, 0.8, 0.9, 1))
		print(levels(ltemp))
		cols <- rev(c("blue", "green", heat.colors(n = nlevels(ltemp)-2)))
		points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, col = cols[ltemp])

		maps::map(add = T)


		pdf(file = file.path(dir.fig_PC, "Reduced_StudyArea", "Hist_SandContent.pdf"))
			hist(resSoils[2, 1, 1, , "SWinput_Soil_topLayers_Sand_fraction"], breaks = 100)
		dev.off()
		pdf(file = file.path(dir.fig_PC, "Reduced_StudyArea", "Hist_AI_CurrentOnly.pdf"))
		hist(resDefinition[3, ircp, igcm, , "UNAridityIndex_Normals_none_mean"])
		dev.off()
		
		#comparing dStudy vs dStudy2
		ia <- 2; ircp <- 1; igcm <- 1
		pdf(height = 10, width = 25, file = file.path(dir.fig_PC, "Reduced_StudyArea", paste0("ReducedStudyArea_", switch(ia, "AnyCondition", "CurrentOnly"), ".pdf")))
			plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("orange")[dStudy[ia, ircp, igcm,]])
			points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, col = adjustcolor("gray", alpha.f = 0.5)[dStudy2[ia, ircp, igcm, ]])
			temp <- ifelse(dStudy[ia, ircp, igcm,] == 1 & is.na(dStudy2[ia, ircp, igcm,]), 1, NA)
			points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, col = adjustcolor("green", alpha.f = 0.5)[ifelse(is.na(dSand90[ia, ircp, igcm, ]) & temp, 1, NA)])
			points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, col = adjustcolor("red", alpha.f = 0.5)[ifelse(is.na(dAI005[ia, ircp, igcm, ]) & temp, 1, NA)])
			points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, col = adjustcolor("purple", alpha.f = 0.5)[ifelse(is.na(dAI05[ia, ircp, igcm, ]) & temp, 1, NA)])
			points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, col = adjustcolor("blue", alpha.f = 0.8)[ifelse(is.na(dMAT0[ia, ircp, igcm, ]) & temp, 1, NA)])
			maps::map(add = T); maps::map('state', add = T)
			legend("bottom", legend = c("reduced study area", "reduced by MAT < 0", "reduced by AI < 0.05", "reduced by sand > 0.9"), pch = 16, cex = 2, col = c("tan", "blue", "red", "green"))
		dev.off()
	}

	save(dStudy2, file = ftemp)
	save(dMAT0, dAI005, dAI05, dSand90, dD, file = file.path(dir.out_PC, paste0("dStudy2_Attribution_", tag_dbScen, ".RData")))
} else {
	load(file = ftemp)
	load(file = file.path(dir.out_PC, paste0("dStudy2_Attribution_", tag_dbScen, ".RData")))
}



#---CALCULATE SHIFTING ZONES (compared to current extent and for each scenario based on "MetDef_ThisCond"; there are no shifts in the fixed study area definitions, i.e., "Simulation" and "MetDef_Any17Cond")

calculate_shift <- function(data) {
# str(data): num [1:2, 1:3, 1:17, 1:20021] 1 1 1 NA 1 NA 1 NA 1 1 ...
# - attr(*, "dimnames") = List of 4
# ..$ : chr [1:2] "MetDef_Any17Cond" "MetDef_ThisCond"
# ..$ : chr [1:3] "Current" "RCP45" "RCP85"
# ..$ : chr [1:17] "Current" "CanESM2" "CESM1-CAM5" "CSIRO-Mk3-6-0" ...
# ..$ : NULL

	stopifnot(unique(as.vector(data)) %in% c(NA, 0, 1),
				"MetDef_ThisCond" %in% dimnames(data)[[1]])
	
	res <- array(NA, dim = c(length(reqRCPs), length(reqGCMs), nrow(dLoc), 1 + length(shifts)), dimnames = list(reqRCPs, reqGCMs, NULL, c("shifts_code", shifts))) #this is valid for "MetDef_ThisCond"

	temp_cur <- is.na(data["MetDef_ThisCond", currentSc, currentSc, ]) | data["MetDef_ThisCond", currentSc, currentSc, ] == 0
	for (ircp in seq_along(reqRCPs)) {
		for (igcm in seq_along(reqGCMs)) {
			temp_sc <- is.na(data["MetDef_ThisCond", reqRCPs[ircp], reqGCMs[igcm], ]) | data["MetDef_ThisCond", reqRCPs[ircp], reqGCMs[igcm], ] == 0
			res[ircp, igcm, , "shifts_code"] <- ifelse(temp_cur,
													ifelse(temp_sc,	#not in data under current conditions & (not) in data under scenario
														NA,									#	-> not included at all
														shifts_code[shifts == "leading"]),	#	-> leading edge
													ifelse(temp_sc,	#in data under current conditions & (not) in data under scenario
														shifts_code[shifts == "trailing"],	# 	-> trailing edge
														shifts_code[shifts == "stable"]))	# 	-> stable
			
			for (iss in seq_along(shifts)) {
				res[ircp, igcm, , shifts[iss]] <- ifelse(res[ircp, igcm, , "shifts_code"] == shifts_code[iss], 1, NA)
			}
		}
	}


	return(res)
#str(res): num [1:2, 1:16, 1:20021, 1:4] NA NA NA NA NA NA NA NA NA NA ...
# - attr(*, "dimnames") = List of 4
# ..$ : chr [1:2] "RCP45" "RCP85"
# ..$ : chr [1:16] "CanESM2" "CESM1-CAM5" "CSIRO-Mk3-6-0" "EC-EARTH" ...
# ..$ : NULL
# ..$ : chr [1:4] "shifts_code" "trailing" "stable" "leading"
}

# Copy shifting zone data to corresponding new slots
add_shifts_v4 <- function(data, dShift) {
#str(data): num [1:3, 1:3, 1:17, 1:20021, 1:nvar] 1002 NA NA 1002 NA ...
# - attr(*, "dimnames") = List of 5
# ..$ : chr [1:3] ("Simulation") "MetDef_Any17Cond" "MetDef_ThisCond"
# ..$ : chr [1:3] "Current" "RCP45" "RCP85"
# ..$ : chr [1:17] "Current" "CanESM2" "CESM1-CAM5" "CSIRO-Mk3-6-0" ...
# ..$ : NULL
# ..$ : chr [1:nvar] var
 	
 
 	stopifnot("MetDef_Any17Cond" %in% dimnames(data)[[1]])
 	
 	fixdata <- fix_var_dim(data, has_area_dim = TRUE)
 	dat_study_areas_all <- dimnames(fixdata$data)[[1]]

	res <- array(NA, dim = c(length(dat_study_areas_all) + length(shifts), dim(fixdata$data)[-1]), dimnames = c(list(c(dat_study_areas_all, shifts)), dimnames(fixdata$data)[-1]))
	
	for (ia in seq_along(dat_study_areas_all))
		res[dat_study_areas_all[ia], , , , ] <- fixdata$data[dat_study_areas_all[ia], , , , ]
	
	# Not applicable to current
	for (iss in seq_along(shifts)) {
		for (iv in seq_along(fixdata$vars)) {
			res[shifts[iss], -1, -1, , iv] <- sweep(fixdata$data["MetDef_Any17Cond", -1, -1, , iv], MARGIN = 1:3, STATS = dShift[, , , shifts[iss]], "*")
		}
	}
	
	return(if (fixdata$has_var_dim) res else drop(res))
}



if (!file.exists(ftemp <- file.path(dir.out_PC, paste0("dShift2_", tag_dbScen, ".RData")))) {
	dShift2 <- calculate_shift(data = dStudy2)
	dShift2_AI005 <- calculate_shift(data = dAI005)
	dShift2_AI05 <- calculate_shift(data = dAI05)
	dShift2_MAT0 <- calculate_shift(data = dMAT0)
	dShift2_Sand90 <- calculate_shift(data = dSand90)
	dShift2_D <- calculate_shift(data = dD)
	

	save(dShift2, file = ftemp)
	save(dShift2_AI05, dShift2_AI005, dShift2_D, dShift2_MAT0, dShift2_Sand90, file = file.path(dir.out_PC, paste0("dShift2_Attribution_", tag_dbScen, ".RData")))

	dStudy2 <- add_shifts_v4(data = dStudy2, dShift = dShift2)
		#str(dStudy2): num [1:5, 1:3, 1:17, 1:20021] NA NA NA NA NA NA NA NA NA NA ...
		# - attr(*, "dimnames") = List of 4
		# ..$ : chr [1:5] "MetDef_Any17Cond" "MetDef_ThisCond" "trailing" "stable" ...
		# ..$ : chr [1:3] "Current" "RCP45" "RCP85"
		# ..$ : chr [1:17] "Current" "CanESM2" "CESM1-CAM5" "CSIRO-Mk3-6-0" ...
		# ..$ : NULL
 
 	save(dStudy2, file = file.path(dir.out_PC, paste0("dStudy2_", tag_dbScen, ".RData")))
} else {
	load(file = ftemp)
	load(file = file.path(dir.out_PC, paste0("dShift2_Attribution_", tag_dbScen, ".RData")))
}


#---Check that shifts were properly calculated
#	- sand content does not change with climate condition
stopifnot(unique(as.vector(dShift2_Sand90[, , , "shifts_code"])) %in% c(NA, 0)) 

#	- shifts align with study area
for (ircp in seq_along(reqRCPs)) {
	for (igcm in seq_along(reqGCMs)) {
		dshift <- dShift2[reqRCPs[ircp], reqGCMs[igcm], , "shifts_code"]
		# current | scenario == trailing | stable | leading
		test1a <- as.integer(!is.na(dStudy2["MetDef_ThisCond", reqRCPs[ircp], reqGCMs[igcm], ]) | !is.na(dStudy2["MetDef_ThisCond", currentSc, currentSc, ]))
		test1b <- as.integer(ifelse(dshift %in% c(-1, 0, 1), 1, 0))
		test1c <- as.integer(!is.na(dShift2[reqRCPs[ircp], reqGCMs[igcm], , "trailing"]) | !is.na(dShift2[reqRCPs[ircp], reqGCMs[igcm], , "stable"]) | !is.na(dShift2[reqRCPs[ircp], reqGCMs[igcm], , "leading"]))
		test1d <- as.integer(!is.na(dStudy2["trailing", reqRCPs[ircp], reqGCMs[igcm], ]) | !is.na(dStudy2["stable", reqRCPs[ircp], reqGCMs[igcm], ]) | !is.na(dStudy2["leading", reqRCPs[ircp], reqGCMs[igcm], ]))
		# current + scenario == stable
		test2a <- as.integer(!is.na(dStudy2["MetDef_ThisCond", reqRCPs[ircp], reqGCMs[igcm], ]) & !is.na(dStudy2["MetDef_ThisCond", currentSc, currentSc, ]))
		test2b <- as.integer(ifelse(dshift %in% c(0), 1, 0))
		test2c <- as.integer(!is.na(dShift2[reqRCPs[ircp], reqGCMs[igcm], , "stable"]))
		test2d <- as.integer(!is.na(dStudy2["stable", reqRCPs[ircp], reqGCMs[igcm], ]))
		# scenario == stable | leading
		test3a <- as.integer(!is.na(dStudy2["MetDef_ThisCond", reqRCPs[ircp], reqGCMs[igcm], ]))
		test3b <- as.integer(ifelse(dshift %in% c(0, 1), 1, 0))
		test3c <- as.integer(!is.na(dShift2[reqRCPs[ircp], reqGCMs[igcm], , "stable"]) | !is.na(dShift2[reqRCPs[ircp], reqGCMs[igcm], , "leading"]))
		test3d <- as.integer(!is.na(dStudy2["stable", reqRCPs[ircp], reqGCMs[igcm], ]) | !is.na(dStudy2["leading", reqRCPs[ircp], reqGCMs[igcm], ]))
		
		print(paste(ircp, igcm, identical(test1a, test1b), identical(test1a, test1c), identical(test1a, test1d),
								identical(test2a, test2b), identical(test2a, test2c), identical(test2a, test2d),
								identical(test3a, test3b), identical(test3a, test3c), identical(test3a, test3d)))
	}
}


if (FALSE) {
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = dStudy[2, 1, 1,])
	ircp <- 2; igcm <- 16
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2+dShift[ircp, igcm,, "shifts_code"]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2+dShift_AI[ircp, igcm,, "shifts_code"]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2+dShift_D[ircp, igcm,, "shifts_code"]])

	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2+dShift2[ircp, igcm,, "shifts_code"]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("red", alpha.f = 0.5)[dShift2[ircp, igcm,, "trailing"]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("gray", alpha.f = 0.5)[dShift2[ircp, igcm,, "stable"]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("blue", alpha.f = 0.5)[dShift2[ircp, igcm,, "leading"]])
	
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2+dShift2_AI05[ircp, igcm,, "shifts_code"]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2+dShift2_AI005[ircp, igcm,, "shifts_code"]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2+dShift2_MAT0[ircp, igcm,, "shifts_code"]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2+dShift2_Sand90[ircp, igcm,, "shifts_code"]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2+dShift2_D[ircp, igcm,, "shifts_code"]])

	maps::map(col = "darkgreen", add = T)

}



#---RESTRICT EXTRACTED RESPONSE VARIABLE OBJECTS BY STUDY AREA 2 (slots of study_areas) AND ADD SHIFTING ZONE INFORMATION

for (id in seq_along(sets_names_extracted)) {
	if (!file.exists(ftemp <- file.path(dir.out_PC, paste0(sets_names_extracted2[id], "_", tag_dbScen, ".RData")))) {
		temp <- limit_to_study_area_v4(data = get(sets_names_extracted[id]), dStudy = dStudy2)
		temp <- add_shifts_v4(data = temp, dShift = dShift2)
			#str(temp): num [1:6, 1:3, 1:17, 1:20021, 1:nvar] 1002 NA NA NA NA ...
			# - attr(*, "dimnames") = List of 5
			# ..$ : chr [1:6] "Simulation" "MetDef_Any17Cond" "MetDef_ThisCond" "trailing" "stable" "leading"
			# ..$ : chr [1:3] "Current" "RCP45" "RCP85"
			# ..$ : chr [1:17] "Current" "CanESM2" "CESM1-CAM5" "CSIRO-Mk3-6-0" ...
			# ..$ : NULL
			# ..$ : chr [1:nvar] vars
		assign(x = sets_names_extracted2[id], value = temp, envir = .GlobalEnv)
	
		ctemp <- test_coherence_among_study_areas(data = temp)
		stopifnot(nrow(ctemp) == 0)

		save(list = sets_names_extracted2[id], file = ftemp)
	} else {
		load(file = ftemp)
	}
} 

if (FALSE) {

	get_colors <- function(var, breaks = 5, add_cols = "blue") {
		ltemp <- cut(var, breaks = breaks)
		cols <- c(add_cols, heat.colors(n = nlevels(ltemp)))
		return(list(cols = cols[ltemp], legend_col = cols, legend_text = levels(ltemp)))
	}

	#inputs
	ia <- 1; ircp <- 1; igcm <- 1
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = dStudy[ia, ircp, igcm,])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, col = (temp <- get_colors(var = resClimate[1 + ia, ircp, igcm, , "MAT_C_mean"], breaks = c(-Inf, 0, 5, 10, 15, Inf)))$cols)
	legend(x = "bottom", legend = temp$legend_text, col = temp$legend_col, pch = 15, cex = 2)
	
	ia <- 1; ircp <- 1; igcm <- 1
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = dStudy2[ia, ircp, igcm,])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, col = get_colors(var = resClimate[1 + ia, ircp, igcm, , "MAT_C_mean"], breaks = c(-Inf, 0, 5, 10, 15, Inf))$cols)

}





#---CREATE GRID MASKS FOR STUDY AREA 2 GLOBALLY AND PER REGION

rastername_mask <- "StudyAreaMask_CurrentFuture.asc" # Origin: /Users/drschlaep/Documents/drschlaepfer_professional/2_Research/200907_UofWyoming_PostDoc/Product_PowellCenter/5_Data/1_StudyLocations/4_Maps/4_Geographic
mask_global <- raster(x = file.path(dir.gis, "CurrentFuture", rastername_mask))
projection(mask_global) <- WGS84

#load: regions
load(file.path(dir.gis, "CurrentFuture", "regions.RData")) # Origin: /Volumes/DRS4_Calluna/drschlaepfer/2_Research/200907_UofWyoming_PostDoc/Projects_My/Product_PowellCenter/5_Data/1_StudyLocations/4_Maps/6_Figures&Tables/Regions/Regions.RData

dir.create(dir.gis_Any17Cond <- file.path(dir.gis, "Any17Cond"), showWarnings = FALSE)

mask_Any17Cond <- list()
for (ircp in seq_along(reqRCPs)) {
#-Create mask of 'StudyArea2_Any17Cond' per RCP with global extent
	rastername_mask_Any17Cond <- paste0("StudyAreaMask_Any17Cond_", reqRCPs[ircp], ".asc")
	if (!file.exists(ftemp <- file.path(dir.gis_Any17Cond, rastername_mask_Any17Cond))) {
		mask_Any17Cond[[reqRCPs[ircp]]] <- calc.RasterFromData(Xcoord = dLoc[, "X_WGS84"], Ycoord = dLoc[, "Y_WGS84"], dataVector = dStudy2["MetDef_Any17Cond", reqRCPs[ircp], currentSc,], mask = mask_global)
		writeRaster(mask_Any17Cond[[reqRCPs[ircp]]], file = ftemp, datatype = "INT1S", NAflag = -9, overwrite = TRUE)
	} else {
		mask_Any17Cond[[reqRCPs[ircp]]] <- raster(file.path(dir.gis_Any17Cond, rastername_mask_Any17Cond))
		projection(mask_Any17Cond[[reqRCPs[ircp]]]) <- WGS84
	}


	#-Create regional masks of 'StudyArea2_Any17Cond' with global extent
	temp_files <- list.files(dir.gis_Any17Cond, pattern = paste0("AreaMask_Any17Cond_", reqRCPs[ircp], ".asc"))
	if (!all(sapply(regions_N, function(i) length(grep(paste0("Global", i), temp_files)) == 1))) {
		for (i in regions_N) {
			temp <- mask(calc(regions, function(x, ...) ifelse(x == i, i, NA)), mask_Any17Cond[[reqRCPs[ircp]]],
						filename = file.path(dir.gis_Any17Cond, paste0("Global", i, "AreaMask_Any17Cond_", reqRCPs[ircp], ".asc")),
						datatype = "INT1S", NAflag = -9, overwrite = TRUE)
		}
	}

	#-Create regional masks of 'StudyArea2_Any17Cond' with regional extent
	if (!all(sapply(regions_N, function(i) length(grep(paste0("Region", i), temp_files)) == 1))) {
		masks_Any17Cond_regional_global <- load_regional_masks(dir.gis = dir.gis_Any17Cond, pattern = "Global", rcp = reqRCPs[ircp])
		for (i in regions_N) {
			print(paste("Prepare masks with regional extents:", i))
			
			if (cellStats(masks_Any17Cond_regional_global[[i]], "countNA") == ncell(masks_Any17Cond_regional_global[[i]])) next
			
			temp <- trim(masks_Any17Cond_regional_global[[i]])
			# aesthetic adjustments
			if (i == 1) {
				ext <- extent(temp)
				temp <- crop(temp, y = extent(ext[1], ext[2], -51, -15))
			}
	
			writeRaster(temp, filename = file.path(dir.gis_Any17Cond, paste0("Region", i, "AreaMask_Any17Cond_", reqRCPs[ircp], ".asc")), datatype = "INT1S", NAflag = -9, overwrite = TRUE)
		}
	}
}



#---CALCULATE SIGN OF CORRELATION WITH ARIDITY (for use in increasing or decreasing ranking of GCMs)
#---Determine sign of kendall's tau rank correlation between response variables and aridity (i.e, -AI because cor(AI, aridity) = -1)
# Note: point-biseral correlation (i.e., == Pearson correlation) rpb between response variables and study area, i.e., positive, if variable larger in study area; negative, if large outside
#	- rpb doesn't work because values outside study area are arbitrary (simulation area) -> correlation must be determined within study area and with a continuous variable

calculate_tau_against_AI <- function(AI, data, vars = NULL) {
# str(AI): num [1:3, 1:3, 1:17, 1:20021] 1 1 1 NA 1 NA 1 NA 1 1 ...
# - attr(*, "dimnames") = List of 4
# ..$ : chr [1:3] "Simulation" "MetDef_Any33Cond" "MetDef_ThisCond"
# ..$ : chr [1:3] "Current" "RCP45" "RCP85"
# ..$ : chr [1:17] "Current" "CanESM2" "CESM1-CAM5" "CSIRO-Mk3-6-0" ...
# ..$ : NULL

# str(data): num [1:3, 1:3, 1:17, 1:20021, 1:nvars] 60 NA NA NA NA NA NA NA NA NA ...
# - attr(*, "dimnames") = List of 5
# ..$ : chr [1:3] "Simulation" "MetDef_Any33Cond" "MetDef_ThisCond"
# ..$ : chr [1:3] "Current" "RCP45" "RCP85"
# ..$ : chr [1:17] "Current" "CanESM2" "CESM1-CAM5" "CSIRO-Mk3-6-0" ...
# ..$ : NULL
# ..$ : chr [1:nvars] vars

	stopifnot(identical(dimnames(AI), dimnames(data)[-5]))

	if (is.null(vars)) {
		vars <- dimnames(data)[[5]]
	} else {
		stopifnot(vars %in% dimnames(data)[[5]])
	}

	tau <- array(NA, dim = c(length(study_areas_all), length(reqRCPs_wCur), length(reqGCMs_wCur), length(vars)), dimnames = list(study_areas_all, reqRCPs_wCur, reqGCMs_wCur, vars))

	# step 1: correlations for each GCM
	for (ia in seq_along(study_areas_all)) {
		for (ircp in seq_along(reqRCPs_wCur)) {
			for (igcm in seq_along(reqGCMs_wCur)) {
				x <- -AI[ia, ircp, igcm, ] # lower AI = more arid
				for (iv in seq_along(vars)) {
					tau[ia, ircp, igcm, iv] <- calc_fast_tau(x, y = data[study_areas_all[ia], ircp, igcm, , vars[iv]]) # positive: higher vars[iv] = more arid
				}
			}
		}
	}

	# step 2: ranks among GCM aggregations
	median_tau <- apply(tau, c(4, 1), function(x) c(median(x, na.rm = T), range(x, na.rm = T)))
	dimnames(median_tau)[[1]] <- c("median", "min", "max")
	
	for (iv in seq_along(vars)) {
		temp <- range(median_tau["median", iv, ], na.rm = TRUE)
		if (all(is.finite(temp)) && length(temp) == 2 && findInterval(0, c(-Inf, temp, Inf)) == 2)
			warning(paste("Variable", vars[iv], "has different correlation signs with AI for different study area extents:", paste(signif (median_tau["median", iv, ], 3), collapse = ", ")))
	}

	return(list(tau = tau, median_tau = median_tau))
}


sets_names_cor2 <- paste0(sets_names_extracted2, "_corAI")

for (id in seq_along(sets_names_cor2)) {
	if (!file.exists(ftemp <- file.path(dir.out_PC, paste0(sets_names_cor2[id], "_", tag_dbScen, ".RData")))) {
		temp <- calculate_tau_against_AI(AI = resDefinition2[, , , , "UNAridityIndex_Normals_none_mean"], data = get(sets_names_extracted2[id]))

		# Variable SWP_topLayers_DailyMin_doy has different correlation signs with AI for different study area extents: 0.00439, -0.00768, -0.0673
		#	- mean: -0.02353489
		# Variable TempAir_m1_C_mean has different correlation signs with AI for different study area extents: 0.222, 0.0802, -0.0155
		
		assign(x = sets_names_cor2[id], value = temp, envir = .GlobalEnv)
	
		save(list = sets_names_cor2[id], file = ftemp)
	} else {
		load(file = ftemp)
	}
}



# Function to extract correlation
get_sign <- function(cors, var = NULL, area = NULL) {
	if (inherits(cors, "matrix") || inherits(cors, "data.frame")) {
		temp_sign <- cors[var, area]
		if (is.na(temp_sign)) temp_sign <- mean(cors[var, ], na.rm = TRUE)
	} else {
		temp_sign <- cors
	}
	return(temp_sign)
}


#---ENSEMBLE GCMs PER CELL (only used for maps and scatterplots, i.e., whenever cells are the final aggregation level; if cells are not the final aggregation level, then need to first aggregate for each GCM before taking the ranks/ensembles

calculate_ensemble_percell <- function(data, resp = TRUE, signAI_vars = 1, dShift) {
# str(data): num [1:3, 1:3, 1:17, 1:20021, 1:nvars] 60 NA NA NA NA NA NA NA NA NA ...
# - attr(*, "dimnames") = List of 5
# ..$ : chr [1:3] ("Simulation") "MetDef_Any17Cond" "MetDef_ThisCond"
# ..$ : chr [1:3] "Current" "RCP45" "RCP85"
# ..$ : chr [1:17] "Current" "CanESM2" "CESM1-CAM5" "CSIRO-Mk3-6-0" ...
# ..$ : NULL
# ..$ : chr [1:nvars] vars
#str(dShift): num [1:2, 1:16, 1:20021, 1:4] NA NA NA NA NA NA NA NA NA NA ...
# - attr(*, "dimnames") = List of 4
# ..$ : chr [1:2] "RCP45" "RCP85"
# ..$ : chr [1:16] "CanESM2" "CESM1-CAM5" "CSIRO-Mk3-6-0" "EC-EARTH" ...
# ..$ : NULL
# ..$ : chr [1:4] "shifts_code" "trailing" "stable" "leading"
	
	has_area_dim <- any(unlist(dimnames(data)[1:2]) %in% study_areas_and_shifts)
	if (has_area_dim) {
		areas <- study_areas_and_shifts
	} else {
		areas <- shifts
		dimns <- dimnames(data)
		dim(data) <- c(1, dim(data)) #append a first 1-entry dimension to make dShift_XXX-type objects compatible with resXXX-type objects
		n_dim <- length(dim(data))
		dimnames(data) <- modifyList(dimns, list(areas = "none"))[c(n_dim, 1:(n_dim - 1))]
	}
	
	
	fixdat <- fix_var_dim(data, has_area_dim)
	rm(data)
	rankedGCM <- array(NA, dim = c(length(areas), length(reqRCPs), length(ranks), nrow(dLoc), length(fixdat$resvars)), dimnames = list(areas, reqRCPs, ranks, NULL, fixdat$resvars))

	dim_areas <- dimnames(fixdat$data)[[1]]

	irs <- seq_along(ranks)
	for (ircp in seq_along(reqRCPs)) {
		for (iv in seq_along(fixdat$vars)) {
			print(paste(Sys.time(), ":", reqRCPs[ircp], ", ", fixdat$vars[iv]))
			
			if (has_area_dim && resp) {
				for (ia in seq_along(study_areas_v4)) { #rank over already subsetted study areas
					rankedGCM[study_areas_v4[ia], ircp, irs, , iv] <- apply(fixdat$data[study_areas_v4[ia], reqRCPs[ircp], -1, , fixdat$vars[iv]], 2, function(x)
							calc_ensemble4(x, signed = get_sign(signAI_vars, fixdat$vars[iv], study_areas_v4[ia])))
				}
			
				for (ish in seq_along(shifts)) {
					if (shifts[ish] %in% dim_areas) {
						rankedGCM[shifts[ish], ircp, irs, , iv] <- apply(fixdat$data[shifts[ish], reqRCPs[ircp], -1, , fixdat$vars[iv]], 2, function(x)
								calc_ensemble4(x, signed = get_sign(signAI_vars, fixdat$vars[iv], "MetDef_ThisCond")))
					} else {
						#rank over shifts that subset the area (need to use here "MetDef_Any17Cond" because others would miss 'trailing' cells)
						rankedGCM[shifts[ish], ircp, irs, , iv] <- apply(dShift[reqRCPs[ircp], , , shifts[ish]] * fixdat$data["MetDef_Any17Cond", reqRCPs[ircp], -1, , fixdat$vars[iv]], 2, function(x)
								calc_ensemble4(x, signed = get_sign(signAI_vars, fixdat$vars[iv], "MetDef_Any17Cond")))
					}
				}
			} else { #study area is agreement among GCMs and uses calc_ensemble3
				x <- fixdat$data["MetDef_ThisCond", reqRCPs[ircp], , , fixdat$vars[iv]]
				if (currentSc %in% dimnames(temp)[[1]]) x <- x[-1, ]
				rankedGCM[iv, ircp, irs, , 1] <- apply(x, 2, function(x)
													calc_ensemble3(x, signed = get_sign(signAI_vars, fixdat$vars[iv], "MetDef_ThisCond")))
			}
		}
	}

#str(rankedGCM): num [1:5, 1:2, 1:3, 1:20021, 1:nvars] NA NA NA NA NA NA NA NA NA NA ...
# - attr(*, "dimnames") = List of 5
# ..$ : chr [1:5] "MetDef_Any17Cond" "MetDef_ThisCond" "trailing" "stable" ...
# ..$ : chr [1:2] "RCP45" "RCP85"
# ..$ : chr [1:3] "2" "8" "15"
# ..$ : NULL
# ..$ : chr [1:nvars] vars
	return(if (has_area_dim && fixdat$has_var_dim) rankedGCM else drop(rankedGCM))
}


# Calculate ensembles per cell for response data
sets_names_rankpercell2 <- paste0(sets_names_extracted2, "_rankpercell")

for (id in seq_along(sets_names_rankpercell2)) {
	if (!file.exists(ftemp <- file.path(dir.out_PC, paste0(sets_names_rankpercell2[id], "_", tag_dbScen, ".RData")))) {
		print(paste(Sys.time(), "calculating ensembles over GCMs for", sets_names_rankpercell2[id]))
		
		temp <- calculate_ensemble_percell(data = get(sets_names_extracted2[id]), resp = TRUE, 
										signAI_vars = get(sets_names_cor2[id])$median_tau["median", ,],
										dShift = dShift2)
		#stopifnot(nrow(test_coherence_among_study_areas(data = temp)) == 0)
		assign(x = sets_names_rankpercell2[id], value = temp, envir = .GlobalEnv)
	
		save(list = sets_names_rankpercell2[id], file = ftemp)
	} else {
		load(file = ftemp)
	}
}


# Test coherence among study areas and shifts
for (id in seq_along(sets_names_rankpercell2)) {
	load(file.path(dir.out_PC, paste0(sets_names_rankpercell2[id], "_", tag_dbScen, ".RData")))
	temp <- test_coherence_among_study_areas(data = get(sets_names_rankpercell2[id]))
	
	print(paste(Sys.time(), sets_names_rankpercell2[id], "has", nrow(temp), "incoherences"))
}

if (FALSE) {
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = dStudy2[2, 1, 1,])
	ircp <- 3; igcm <- 2
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2+dShift2[ircp, igcm,, "shifts_code"]])
	ia <- 2; ircp <- 2; ir <- 1; iv <- 1
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, col = (temp <- get_colors(var = resClimate2_rankpercell[ia, ircp, ir, , iv], breaks = 5))$cols)
	legend(x = "bottom", legend = temp$legend_text, col = temp$legend_col, pch = 15, cex = 2)

	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("red", alpha.f = 0.5)[ifelse(!is.na(resClimate2_rankpercell[3, ircp, ir,, iv]), 1, NA)])
	#points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("red", alpha.f = 0.5)[ifelse(!is.na(resClimate2_rankpercell[3, ircp, ir,, iv]), 1, NA)])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("gray", alpha.f = 0.3)[ifelse(!is.na(resClimate2_rankpercell[4, ircp, ir,, iv]), 1, NA)])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("blue", alpha.f = 0.3)[ifelse(!is.na(resClimate2_rankpercell[5, ircp, ir,, iv]), 1, NA)])

	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("black", "black", "red", "gray", "blue")[ia][ifelse(!is.na(resClimate2_rankpercell[ia, ircp, ir,, iv]), 1, NA)])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("black", "black", "red", "gray", "blue")[ia][resResponse2_rankpercell[ia, ircp, ir,, iv]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("black", "black", "red", "gray", "blue")[ia][resDefinition2_rankpercell[ia, ircp, ir,, iv]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("black", "black", "red", "gray", "blue")[ia][resSoils2_rankpercell[ia, ircp, ir,, iv]])

	maps::map(col = "darkgreen", add = T)

}


# Calculate ensembles for study areas
sa_names_att2 <- c(sa_names_def2, "dShift2_AI05", "dShift2_AI005", "dShift2_D", "dShift2_MAT0", "dShift2_Sand90")
sa_names_att_rankpercell2 <- paste0(sa_names_att2, "_rankpercell")

for (id in seq_along(sa_names_att_rankpercell2)) {
	if (!file.exists(ftemp <- file.path(dir.out_PC, paste0(sa_names_att_rankpercell2[id], "_", tag_dbScen, ".RData")))) {
		print(paste(Sys.time(), "calculating ensembles over GCMs for", sa_names_att_rankpercell2[id]))
		
		temp <- calculate_ensemble_percell(data = get(sa_names_att2[id]), resp = (id == 1), signAI_vars = 1, dShift = dShift2)
		assign(x = sa_names_att_rankpercell2[id], value = temp, envir = .GlobalEnv)
	
		save(list = sa_names_att_rankpercell2[id], file = ftemp)
	} else {
		load(file = ftemp)
	}
}

if (FALSE) {
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = dStudy2[2, 1, 1,])
	ircp <- 3; igcm <- 2
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2+dShift2[ircp, igcm,]])
	ia <- 1; ircp <- 2; ir <- 2; ish <- 1
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("black", "black", "red", "gray", "blue")[ia][dStudy2_rankpercell[ia, ircp, ir,]])

	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("black", "black", "red", "gray", "blue")[ia][dStudy2_rankpercell[shifts[ish], ircp, ir,]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("pink", alpha.f = 0.4)[dShift2_rankpercell[shifts[ish], ircp, ir,]])
	
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("red", alpha.f = 0.5)[dShift2_rankpercell["trailing", ircp, ir,]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("gray", alpha.f = 0.5)[dShift2_rankpercell["stable", ircp, ir,]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("blue", alpha.f = 0.5)[dShift2_rankpercell["leading", ircp, ir,]])

	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("red", alpha.f = 0.5)[dShift2_AI05_rankpercell["trailing", ircp, ir,]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("gray", alpha.f = 0.5)[dShift2_AI05_rankpercell["stable", ircp, ir,]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("blue", alpha.f = 0.5)[dShift2_AI05_rankpercell["leading", ircp, ir,]])

	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("red", alpha.f = 0.5)[dShift2_AI005_rankpercell["trailing", ircp, ir,]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("gray", alpha.f = 0.5)[dShift2_AI005_rankpercell["stable", ircp, ir,]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("blue", alpha.f = 0.5)[dShift2_AI005_rankpercell["leading", ircp, ir,]])

	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("red", alpha.f = 0.5)[dShift2_D_rankpercell["trailing", ircp, ir,]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("gray", alpha.f = 0.5)[dShift2_D_rankpercell["stable", ircp, ir,]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("blue", alpha.f = 0.5)[dShift2_D_rankpercell["leading", ircp, ir,]])

	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("red", alpha.f = 0.5)[dShift2_MAT0_rankpercell["trailing", ircp, ir,]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("gray", alpha.f = 0.5)[dShift2_MAT0_rankpercell["stable", ircp, ir,]])
	points(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = adjustcolor("blue", alpha.f = 0.5)[dShift2_MAT0_rankpercell["leading", ircp, ir,]])
	
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2 + dShift2_AI05[ircp, ir,]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2 + dShift2_AI005[ircp, ir,]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2 + dShift2_MAT0[ircp, ir,]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2 + dShift2_Sand90[ircp, ir,]])
	plot(dLoc$X_WGS84, dLoc$Y_WGS84, pch = 15, cex = 0.3, asp = 1, col = c("red", "gray", "blue")[2 + dShift2_D_rankpercell[ircp, ir,]])

	maps::map(col = "darkgreen", add = T)

}

# Test that ranks were properly calculated between dStudy2_rankpercell and dShift2_rankpercell
for (ish in seq_along(shifts)) {
	print(paste(shifts[ish], identical(dStudy2_rankpercell[shifts[ish],,,], dShift2_rankpercell[shifts[ish],,,])))
}

# Test that ranks were properly calculated in resResponse data objects
check_alignment <- function(data_ranked, dStudy_ranked) {
	val <- 0
	vars <- dimnames(data_ranked)[[5]]
	for (ia in seq_along(study_areas_and_shifts)) {
		for (ircp in seq_along(reqRCPs)) {
			for (ir in seq_along(ranks)) {
				dat1 <- dStudy_ranked[ia, ircp, ir, ]
				for (iv in seq_along(vars)) {
					dat2 <- data_ranked[ia, ircp, ir, , iv]
					
					ndiff <- sum(abs(as.numeric(is.finite(dat1)) - as.numeric(is.finite(dat2))))
					if (ndiff > 0) {
						val <- val + ndiff
						print(paste0("Study area disagreement: ", ndiff, " cells disagree for ", study_areas_and_shifts[ia], ", ", reqRCPs[ircp], ", ", ranks[ir], "-th rank, variable ", vars[iv]))
					}
				}
			}
		}
	}

	return(val)
}

temp <- list()
for (id in seq_along(sets_names_rankpercell2)) {
	temp[[id]] <- check_alignment(data_ranked = get(sets_names_rankpercell2[id]), dStudy_ranked = dStudy2_rankpercell)
	# ==> differences occurring in variables
	#		- "TranspirationBottomToTranspirationTotal_fraction_mean",
	#		- "SWP_topLayers_DailyMin_doy", "SWP_bottomLayers_DailyMin_doy",
	#		- "Transpiration_DailyMax_doy",
	#		- "DrySoilPeriods_SWPcrit3000kPa_NSadj_bottomLayers_PeriodsForAtLeast10Days_Start_doy"
}

# Same test differently formulated
target <- apply(get("dStudy2_rankpercell"), 1:3, function(x) sum(!is.na(x)))
for (id in seq_along(sets_names_rankpercell2)) {
	x <- get(sets_names_rankpercell2[id])[, , , , ]
	vars <- dimnames(x)[[5]]
	for (iv in seq_along(vars)) {
		temp <- apply(x[, , , , iv], 1:3, function(x) sum(!is.na(x)))
		print(paste(id, sets_names_rankpercell2[id], iv, paste(dim(x), collapse = ":"), identical(temp, target), sum(abs(temp - target), na.rm = TRUE)))
	}
}




if (FALSE) {
	ia <- study_areas_and_shifts[1]; ircp <- reqRCPs[1]; ir <- 1; iv <- 8
	dat1 <- dStudy2_rankpercell[ia, ircp, ir, ]
	dat2 <- resResponse2_rankpercell[ia, ircp, ir, , iv]
	dat3 <- t(resResponse2[ia, ircp, -1, ,iv]); colnames(dat3) <- paste0("res", 1:16)
	dat5 <- t(dShift2[ircp, -1, ]); colnames(dat5) <- paste0("shift", 1:16)
	dat4 <- t(dStudy2[ia, ircp, -1, ]); colnames(dat4) <- paste0("def", 1:16)
	
	dats <- cbind(diff = as.numeric(is.finite(dat1)) - as.numeric(is.finite(dat2)), t1 = as.numeric(is.finite(dat1)), t2 = as.numeric(is.finite(dat2)),
					dat1, dat2, dat3, dat5, dat4)
	
	ids1 <- which(dats[,1]>0)
	ids2 <- which(complete.cases(dats))
	
	dats[ids,]
	head(dats[ids, ])
	dats[ids1[2]:ids1[4], ]
	
	dStudy2[, ircp, , 809]
	dStudy2_rankpercell[, ircp, , 809]
	resResponse2[, ircp,, 809, iv]
	resResponse2_rankpercell[, ircp,, 809, iv]
	apply(is.na(resResponse2["Simulation", -1, -1, , iv]), MARGIN = 1:2, sum)
	#	   CanESM2 CESM1-CAM5 CSIRO-Mk3-6-0 EC-EARTH FGOALS-g2 FGOALS-s2 GFDL-CM3 GISS-E2-R HadGEM2-CC HadGEM2-ES inmcm4 IPSL-CM5A-MR MIROC-ESM MIROC5
	#RCP45   148    267      486   446    445    365   255    398    267    240  508     573    237  336
	#RCP85   39    158      293   322    241    108   195    234    140    160  419     606    156  157
	#   MPI-ESM-MR MRI-CGCM3
	#RCP45    482    364
	#RCP85    340    233

	# ==> a considerable number of sites that differs by RCP and GCM produced NAs for T(bottom) / T(total)
	which_tt <- which(is.na(resResponse2["Simulation", -1, -1, , iv]), arr.ind = TRUE)
	length(unique(which_tt[,3]))	# 1106 sites had at least one NA for T(bottom) / T(total) ==> why?
	hist(which_tt[,3], breaks = 20000) # weird (semi-)regular pattern
}


saveRDS(TRUE, file = file.path(dir.sim_out, paste0("Flag_PreCalculations_", tag_dbScen, ".rds"))) #Indicate that this script has successfully completed


