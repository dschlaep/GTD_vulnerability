################### DETERMINE AREAS WITH POS/NEG RESPONSE ########
#
# Daniel Schlaepfer, 2015-2016
# 
# Determine areas where difference in outcomes between future and current conditions is
# positive/negative for temperate dryland areas for all study_areas_and_shifts x RCP combinations
#	- requests 'get_precalculations' from '5a1_GTD_*.R'
#	- requests 'get_studyareaextents' from '5a1_GTD_*.R'
#
###################################################################


#-------------------------------
#---GLOBAL SETTINGS
comp <- "dropbox"
do_tables <- TRUE
redo_tables <- FALSE

m2_to_km2 <- 1e-6
signum <- c(-1, 1)

#-------------------------------
#---R packages
pkg_reqd <- c("geosphere", "rgeos", "reshape2")
has_loaded <- sapply(pkg_reqd,
	function(lib) require(lib, character.only = TRUE, quietly = FALSE))
stopifnot(has_loaded)

#---Load data and misc. functions
if (comp %in% c("err", "eleos")) {
	dir.gtd <- "/PATH_TO_PROJECT/Product_PowellCenter/6_Projects_Year1"
} else if (comp == "dropbox") {
	dir.gtd <- "/PATH_TO_PROJECT/Product_PowellCenter/6_Projects_Year1"
}
dir.prj <- file.path(dir.gtd, "Prj03_GlobalVulnerability", "4_Analysis", "4_Analysis_v4")


get_precalculations <- TRUE
get_studyareaextents <- TRUE
source(file.path(dir.prj, "5a1_GTD_Prj03v4_Helper.R"))

stopifnot(done_precalculations, done_studyareaextents)

masks_regions <- load_regional_masks(dir.gis = file.path(dir.gis, "CurrentFuture"), pattern = "Region")

#---Directories
dir.create(dir.fig_SAM <- file.path(dir.prj, "6_Results", "11_ArealPosNegResponses"), showWarnings = FALSE)


#-------------------------------
#------TABLES AND FIGURES

if (do_tables) {
	res_names <- sets_names_extracted2[-(3:4)]
	var_names <- list(var_climate, var_response_sel, var_veg)
	var_labels <- list(label_climate, label_response_sel, label_veg)
	val_types <- change_types[2]

	do_regional_change_table <- function(dat, dat_current = NULL, varnames, varlabels, val_type, dir_out, ftag) {
#str(dat_current): num [1:3, 1:3, 1:20021, 1:nvars] 1002 NA NA 987 NA ...
# - attr(*, "dimnames") = List of 4
# ..$ : chr [1:3] "Simulation" "MetDef_Any17Cond" "MetDef_ThisCond"
# ..$ : chr [1:3] "Current" "RCP45" "RCP85"
# ..$ : NULL
# ..$ : chr [1:nvars] vars
#str(dat): str(dat)
# num [1:6, 1:2, 1:16, 1:20021, 1:nvars] 1074 NA NA NA NA ...
# - attr(*, "dimnames") = List of 5
# ..$ : chr [1:6] "Simulation" "MetDef_Any17Cond" "MetDef_ThisCond" "trailing" ...
# ..$ : chr [1:2] "RCP45" "RCP85"
# ..$ : chr [1:16] "CanESM2" "CESM1-CAM5" "CSIRO-Mk3-6-0" "EC-EARTH" ...
# ..$ : NULL
# ..$ : chr [1:nvars] vars
		
		ftag <- clean_name(ftag)
		
		stopifnot(exists("dStudy2"))
		
		for (ircp in seq_along(reqRCPs)) {
			ftemp <- file.path(dir_out, fname <- paste0("Table_ExtentsOfPosNegResponses_", reqRCPs[ircp], "_", ftag, "_", val_type, ".csv"))
			if (redo_tables || !file.exists(ftemp)) {
		
				for (iv in seq_along(varnames)) {
					print(paste(Sys.time(), ftag, reqRCPs[ircp], varnames[iv]))
				
					is_circular <- grepl("_doy", varnames[iv])
					vdat <- dat_sweep(dat[, , , , varnames[iv]], dat_current["Simulation", currentSc, , varnames[iv]], val_type, circular = is_circular)
				
					#---1) Calculate positive/negative areas for each GCM
					rtemp <- array(NA, dim = c(length(signum), length(regions_n), length(shifts), length(reqGCMs)), dimnames = list(signum, regions_n, shifts, reqGCMs))
					
					for (igcm in seq_along(reqGCMs)) {
						for (iss in seq_along(shifts)) {
							xtemp <- ifelse(is.na(temp <- vdat[shifts[iss], reqRCPs[ircp], reqGCMs[igcm], ]), NA, ifelse(temp >= 0, 1, -1))
							for (i in seq_along(regions_n)) {
								ids <- !is.na(dStudy2[shifts[iss], reqRCPs[ircp], reqGCMs[igcm], ]) & dLoc$Region == regions_n[i]
								
								for (ix in seq_along(signum)) {
									ids2 <- ids & (!is.na(xtemp) & xtemp == signum[ix])
								
									if (sum(ids2) > 0) {
										tempSA <- calc.RasterFromData(Xcoord = dLoc$X_WGS84[ids2], Ycoord = dLoc$Y_WGS84[ids2], dataVector = xtemp[ids2], mask = masks_regions[[regions_n[i]]])
										rtemp[ix, i, iss, igcm] <- m2_to_km2 * areaPolygon(rasterToPolygons(tempSA, dissolve = TRUE))
									}
								}
							}
						}
					}
					
					# Aggregate globally
					rtempG <- apply(rtemp, c(1, 4), sum, na.rm = TRUE)
					
					# Aggregate regionally
					rtempR <- apply(rtemp, c(1:2, 4), sum, na.rm = TRUE)
					
					# Calculate positive/negative areas relative to region extent ( = trailing + stable + leading)
					rtempGr <- sweep(rtempG, 2, apply(rtempG, 2, sum), "/")
					rtempRr <- sweep(rtempR, 2:3, apply(rtempR, 2:3, sum), "/")
					rtempr <- sweep(rtemp, c(2, 4), apply(rtemp, c(2, 4), sum, na.rm = TRUE), "/")
					
					
					#---2) Calculate among-GCM distribution of target summary
					rtemp2r <- apply(rtempr, 1:3, calc_ensemble4)
					rtemp2Rr <- apply(rtempRr, 1:2, calc_ensemble4)
					rtemp2Gr <- apply(rtempGr, 1, calc_ensemble4)
					
					
					#---Shape into tables
					mtemp2 <- melt(rtemp2r)
					colnames(mtemp2) <- c("Rank", "ResponseDirection", "Region", "Shifts", varnames[iv])
					mtemp2R <- melt(rtemp2Rr)
					colnames(mtemp2R) <- c("Rank", "ResponseDirection", "Region", varnames[iv])
					mtemp2G <- melt(rtemp2Gr)
					colnames(mtemp2G) <- c("Rank", "ResponseDirection", varnames[iv])
					
					mtempAll <- data.frame(matrix(NA, nrow = nrow(mtemp2) + nrow(mtemp2R) + nrow(mtemp2G), ncol = ncol(mtemp2)))
					colnames(mtempAll) <- colnames(mtemp2)
					
					irow1 <- 1; irow2 <- nrow(mtemp2)
					mtempAll[irow1:irow2, colnames(mtemp2)] <- mtemp2
					irow1 <- irow1 + nrow(mtemp2); irow2 <- irow2 + nrow(mtemp2R)
					mtempAll[irow1:irow2, colnames(mtemp2R)] <- mtemp2R
					irow1 <- irow1 + nrow(mtemp2R); irow2 <- irow2 + nrow(mtemp2G)
					mtempAll[irow1:irow2, colnames(mtemp2G)] <- mtemp2G
					
					if (iv == 1) {
						resT <- mtempAll
					} else {
						resT <- cbind(resT, mtempAll[, varnames[iv]])
					}
				}
				
				colnames(resT)[-(1:4)] <- varnames
				
				write.csv(resT, file = ftemp)
			}
		}


		invisible(NULL)
	}



	print("DrylandResponse: areal positive/negative responses")
	
	for (id in seq_along(res_names)) {
		dir.temp <- dir.fig_SAM
	
		# get data objects
		temp <- fix_var_dim(get(res_names[id]))
		data <- temp$data[, -1, -1, , ]
		vars <- temp$vars
		data_current <- temp$data[study_areas_all, , currentSc, , ]
		if (length(dim(data_current)) <= 3) {
			dimns <- dimnames(data_current)
			dim(data_current) <- c(dim(data_current), 1)
			dimnames(data_current) <- modifyList(dimns, list(vars = vars))
		}
		rm(temp)
		
		# select variables and cells
		ivars <- sapply(var_names[[id]], function(x) grep(x, vars)[1])
		stopifnot(!is.na(ivars))	
		
		for (it in seq_along(val_types)) {
			print(paste(Sys.time(), res_names[id], val_types[it]))
		
		
			do_regional_change_table(dat = data[,,, , ivars],
						dat_current = data_current[,,, ivars],
						varnames = vars[ivars],
						varlabels = var_labels[[id]],
						val_type = val_types[it],
						dir_out = dir.temp, ftag = res_names[id])
		}
	}
}
