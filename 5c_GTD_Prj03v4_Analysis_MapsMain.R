################### MAP MEDIAN GTD EXTENT/VALUES ##################
#
# Daniel Schlaepfer, 2015-2016
# 
# Map median global temperate dryland extents and shifting zones for areas included in 'Any17Cond'
# The function 'do_mainmap_regional_shifted_response' will plot pdfs with 6 panels each (one global panel and one for each of the five regions) for each RCP. 
#	- requests 'get_precalculations' from '5a1_GTD_*.R'
#	- requests 'get_studyareaextents' from '5a1_GTD_*.R'
#
###################################################################


#-------------------------------
#---GLOBAL SETTINGS
comp <- "dropbox"
do_mainmap <- TRUE
redo_maps <- FALSE

#-------------------------------
#---R packages
pkg_reqd <- c("maps")
has_loaded <- sapply(pkg_reqd,
	function(lib) require(lib, character.only = TRUE, quietly = FALSE))
stopifnot(has_loaded)

#---Load data and misc. functions
if (comp %in% c("err", "eleos")) {
	dir.gtd <- "/PATH_TO_PROJECT/Product_PowellCenter/6_Projects_Year1"
} else if (comp == "dropbox") {
	dir.gtd <- "/PATH_TO_PROJECT/Product_PowellCenter/6_Projects_Year1"
}
dir.prj <- file.path(dir.gtd, "Prj03_GlobalVulnerability", "4_Analysis", "4_Analysis_v4")


get_precalculations <- TRUE
get_studyareaextents <- TRUE
source(file.path(dir.prj, "5a1_GTD_Prj03v4_Helper.R"))

stopifnot(done_precalculations, done_studyareaextents)


#---Directories
dir.create(dir.fig_SAM <- file.path(dir.prj, "6_Results", "2_MainMaps_r3"), showWarnings = FALSE)


#-------------------------------
#------GEOGRAPHIC EXTENT MAPS

#- Load data
masks_regions <- lapply(reqRCPs, function(rcp) load_regional_masks(dir.gis = file.path(dir.gis, "Any17Cond"), pattern = "Region", rcp = rcp))
masks_gregions <- lapply(reqRCPs, function(rcp) load_regional_masks(dir.gis = file.path(dir.gis, "Any17Cond"), pattern = "Global", rcp = rcp))


#-------------------------------
#------WITHIN TEXT RESULTS: GEOGRAPHIC EXTENT MAPS


#-------------------------------
#------TABLES AND FIGURES

#-Figure S1. Maps showing the geographic distribution of the study area in each region under current and end of 21st century climate conditions under RCP4.5 and 8.5 for the 2nd, 8th, and 15th GCM-ranks
#-------------------------------
# Create maps with 6 panels to be used as main figure
#	- first panel: current values on word-map with country borders and our 5 regions
#	- one panel each per region: response of RCP8.5/rank8 as difference to current conditions

if (do_mainmap) {
#

	
	do_mainmap_regional_shifted_response <- function(dat, dat_current = NULL, ircp = 2, ir = 2, Any17Cond = FALSE, val_type = change_types, var_type = c("categorical", "continuous"), varname, var_sign = -1, dir_out, ftag = varname) {
#str(dat_current): num [1:20021] NA NA NA NA NA NA NA NA NA NA ...
#str(dat): num [1:5, 1:2, 1:3, 1:20021] NA NA NA NA NA NA NA NA NA NA ...
# - attr(*, "dimnames") = List of 4
# ..$ : chr [1:5] "MetDef_Any17Cond" "MetDef_ThisCond" "trailing" "stable" ...
# ..$ : chr [1:2] "RCP45" "RCP85"
# ..$ : chr [1:3] "1" "8" "16"
# ..$ : NULL

		val_type <- match.arg(val_type)
		ftag <- clean_name(ftag)
		
		ftemp <- file.path(dir_out, fname <- paste0("MainMap_", ftag, "_", reqRCPs[ircp], "_rank", ranks[ir], "_", val_type, ".pdf"))
		if (redo_maps || !file.exists(ftemp)) {
			#---Prepare plot
			# Data
			has_current_values <- !is.null(dat_current["MetDef_Any17Cond", reqRCPs[ircp], ]) && !(sd(dat_current["MetDef_Any17Cond", reqRCPs[ircp], ], na.rm = TRUE) == 0)
			if (has_current_values) dat <- dat_sweep(dat, dat_current["MetDef_Any17Cond", reqRCPs[ircp], ], val_type, circular = grepl("_doy", varname))
			
			# Range limits
			zlimits <- calc_response_limits(dat_cur = dat_current["MetDef_ThisCond", currentSc, ], dat = dat, get_ircps = ircp, get_ranks = ir, Any17Cond = Any17Cond, type = val_type, probs = c(0.005, 0.995))
			zlimits <- calc_response_limits(dat_cur = dat_current["MetDef_ThisCond", currentSc, ], dat = dat, get_ircps = ircp, get_ranks = ir, Any17Cond = Any17Cond, type = val_type, probs = c(0, 1))

			# Colors
			mcols <- get_map_colors(var_type)

			#---Plot
			plot_mainresponse_regional_grids(ircp, ir, mask_global = mask_simulation, mask_regions = masks_regions[[ircp]], mask_gregions = masks_gregions[[ircp]],
								dat_cur = dat_current["MetDef_ThisCond", currentSc, ], dat_shifts = if (!Any17Cond) dat[shifts, , , ] else NULL, dat_Any17Cond = if (Any17Cond) dat["MetDef_Any17Cond", , , ] else NULL,
								var_sign = var_sign, zlims = zlimits$zlims, zextremes = zlimits$zextremes,
								val_crit = switch(EXPR = val_type, Mean = 0, AbsoluteChange = 0, RelativeChange = 1),
								cex = 1, # lists of length 4: current + 3 shifts
								legends = c(has_current_values && !(val_type == "Mean"), TRUE, FALSE, FALSE),
								legends_type = rep(var_type, 4), # "categorical" or "continuous"
								legends_text = list("Study area", shifts, shifts, shifts),
								mapcols = mcols,
								relArealBar = !Any17Cond,
								dir.out = dir_out, fname = fname)
								
			if (FALSE) {
				mask_global = mask_simulation
				mask_regions = masks_regions[[ircp]]
				mask_gregions = masks_gregions[[ircp]]
				dat_cur = dat_current["MetDef_ThisCond", currentSc, ]
				dat_shifts = if (!Any17Cond) dat[shifts, , , ] else NULL
				dat_Any17Cond = if (Any17Cond) dat["MetDef_Any17Cond", , , ] else NULL
				var_sign = var_sign
				zlims = zlimits$zlims
				zextremes = zlimits$zextremes
				val_crit = switch(EXPR = val_type, Mean = 0, AbsoluteChange = 0, RelativeChange = 1)
				cex = 1 # lists of length 4: current + 3 shifts
				legends = c(has_current_values, TRUE, FALSE, FALSE)
				legends_type = rep(var_type, 4) # "categorical" or "continuous"
				legends_text = list("Study area", shifts, shifts, shifts)
				mapcols = mcols
				relArealBar = !Any17Cond
				dir.out = dir_out
				fname = fname
		
			}
		}

		invisible(NULL)
	}

	print("DrylandResponse: regional main map")
	for (id in seq_along(res_names_ranks)) {

		dir.create(dir.temp <- file.path(dir.fig_SAM, res_names[id]), showWarnings = FALSE)
	
		# get data objects
		data <- fix_var_dim(get(res_names_ranks[id]))$data
		temp <- fix_var_dim(get(res_names[id]))
		vars <- temp$vars
		data_current <- temp$data[, , currentSc, , ]
		if (length(dim(data_current)) <= 3) {
			dimns <- dimnames(data_current)
			dim(data_current) <- c(dim(data_current), 1)
			dimnames(data_current) <- modifyList(dimns, list(vars = vars))
		}
		rm(temp)
	
		# obtain correlation with AI
		corAIs <- if (is.character(res_names_cor[id][[1]])) get(res_names_cor[id][[1]])$median_tau["median", , "MetDef_ThisCond"] else 1

		for (ircp in seq_along(reqRCPs)) {
		
			for (iv in seq_along(vars)) {
				type_list_mode <- if (res_names_ranks[id] %in% sa_names_def2[1]) change_types[1] else change_types
				for (it in seq_along(type_list_mode)) {
					print(paste(Sys.time(), reqRCPs[ircp], res_names_ranks[id], vars[iv], type_list_mode[it]))
					do_mainmap_regional_shifted_response(dat = data[, , , , vars[iv]],
								dat_current = data_current[, , , vars[iv]],
								ircp,
								Any17Cond = !(res_names_ranks[id] %in% sa_names_def2[1]), # FALSE, plot shifts; TRUE, plot MetDef_Any17Cond
								val_type = type_list_mode[it],
								var_type = if (substr(res_names_ranks[id], 1, 1) == "d") "categorical" else "continuous",
								varname = vars[iv],
								var_sign = if (!is.na(corAIs[iv])) corAIs[iv] else 1,
								dir_out = dir.temp)
				}
			}
		}
	}
}
