## CREATE RASTER GRIDS FOR EACH EXPORTED RESPONSE VARIABLE ########
#
# Daniel Schlaepfer, 2015-2016
#
###################################################################


#---GLOBAL SETTINGS
comp <- "dropbox"

#-------------------------------
#---R packages
pkg_reqd <- c("raster", "rgdal", "sp", "readr")
has_loaded <- sapply(pkg_reqd,
	function(lib) require(lib, character.only = TRUE, quietly = FALSE))
stopifnot(has_loaded)

#---Load data and misc. functions
if (comp %in% c("err", "eleos")) {
	dir.gtd <- "/PATH_TO_PROJECT/Product_PowellCenter/6_Projects_Year1"
} else if (comp == "dropbox") {
	dir.gtd <- "/PATH_TO_PROJECT/Product_PowellCenter/6_Projects_Year1"
}
dir.prj <- file.path(dir.gtd, "Prj03_GlobalVulnerability", "4_Analysis", "4_Analysis_v4")

#---Directories
dir.in_SAM <- file.path(dir.prj, "6_Results", "0_DataForSharing", "Spreadsheet")
dir.create(dir.out_SAM <- file.path(dir.prj, "6_Results", "0_DataForSharing", "Raster"), recursive = TRUE, showWarnings = FALSE)


#-------------------------------
# Load base raster
mask <- raster::raster(file.path(dir.out_SAM, "pc_dry.asc"))
raster::crs(mask) <- raster::crs("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
mask[] <- NA

# Load location and study areas
xys <- read.csv(file = file.path(dir.in_SAM, "dStudy2_dbTables_exp01.csv"), header = TRUE)
xy_cells <- raster::cellFromXY(mask, xys[, c("X_WGS84", "Y_WGS84")])
stopifnot(length(xy_cells) == nrow(xys))

# Names of exported datasets
obj_exported <- list.files(dir.in_SAM, pattern = ".csv")
obj_exported <- obj_exported[!(obj_exported == "dStudy2_dbTables_exp01.csv" | obj_exported == "dLoc_dbTables_exp01.csv")]

#--- Raster file export
for (k in seq_along(obj_exported)) {
  x <- readr::read_csv(file = file.path(dir.in_SAM, obj_exported[k]))
  
  vars <- names(x)
  vars <- grep("(Region)|(X_WGS84)|(Y_WGS84)|(RasterCell)", vars, value = TRUE, invert = TRUE)
  
  if (length(vars) > 0) for (iv in seq_along(vars)) {
    r <- mask
    r[xy_cells] <- x[, vars[iv]][[1L]]
    
    ftemp <- file.path(dir.out_SAM, paste0(sub(".csv", "", obj_exported[k]), "_", vars[iv], ".asc"))  
    try(raster::writeRaster(r, filename = ftemp, format = "ascii", overwrite = FALSE))
  }
}
