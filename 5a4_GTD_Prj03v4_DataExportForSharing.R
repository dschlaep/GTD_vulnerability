################### PREPARE R OBJECTS FOR DATA SHARING ########
#
# Daniel Schlaepfer, 2016
#
###################################################################


#---GLOBAL SETTINGS
comp <- "dropbox"

#-------------------------------
#---R packages
pkg_reqd <- c("reshape2")
has_loaded <- sapply(pkg_reqd,
	function(lib) require(lib, character.only = TRUE, quietly = FALSE))
stopifnot(has_loaded)

#---Load data and misc. functions
if (comp %in% c("err", "eleos")) {
	dir.gtd <- "/PATH_TO_PROJECT/Product_PowellCenter/6_Projects_Year1"
} else if (comp == "dropbox") {
	dir.gtd <- "/PATH_TO_PROJECT/Product_PowellCenter/6_Projects_Year1"
}
dir.dat <- file.path(dir.gtd, "Prj03_GlobalVulnerability", "1_PC_TempDry_Simulations_Prj03_r2", "4_Data_SWOutputAggregated", "DATA_v4")
dir.prj <- file.path(dir.gtd, "Prj03_GlobalVulnerability", "4_Analysis", "4_Analysis_v4")

#---Directories
dir.create(dir.out_SAM <- file.path(dir.prj, "6_Results", "0_DataForSharing"), showWarnings = FALSE)


#-------------------------------
#---Raster cell locations
if (!exists("dLoc"))
  load(list.files(dir.dat, pattern = "dLoc_dbTables_exp01.RData", full.names = TRUE, recursive = TRUE))

label.regions <- c("South America", "Southern Africa", "Eastern Asia", "Western & Central Asia", "Western Mediterranean", "North America")
xy <- dLoc[, c("Region", "X_WGS84", "Y_WGS84")]
xy[, "Region"] <- label.regions[xy[, "Region"]]
ncell <- nrow(xy)

write.csv(xy, file = file.path(dir.out_SAM, "dLoc_dbTables_exp01.csv"), row.names = FALSE)


#---Study areas
if (!exists("dStudy2"))
  load(list.files(dir.dat, pattern = "dStudy2_dbTables_exp01.RData", full.names = TRUE, recursive = TRUE))

temp <- reshape2::melt(dStudy2)
wex <- reshape2::dcast(temp, Var4 ~ Var1 + Var2 + Var3)
names(wex)[1] <- "RasterCell"
inacol <- apply(wex, 2, function(x) all(is.na(x)))
if (any(inacol)) wex <- wex[, !inacol]

write.csv(cbind(xy, wex), file = file.path(dir.out_SAM, "dStudy2_dbTables_exp01.csv"), row.names = FALSE)



#---Data sets
# Names of datasets to export
obj_export <- c("dShift2_Attribution_dbTables_exp01.RData",
                "dShift2_dbTables_exp01.RData",
                "dStudy2_Attribution_dbTables_exp01.RData",
                "resBudyko2_dbTables_exp01.RData",
                "resClimate2_dbTables_exp01.RData",
                "resDefinition2_dbTables_exp01.RData",
                "resPPT2_dbTables_exp01.RData",
                "resResponse2_dbTables_exp01.RData",
                "resSoils2_dbTables_exp01.RData",
                "resTempAir2_dbTables_exp01.RData",
                "resTransp2_dbTables_exp01.RData",
                "resVeg2_dbTables_exp01.RData",
                "resVWC2_dbTables_exp01.RData")

# Loop through dataset names
for (k in seq_along(obj_export)) {
  # Load dataset
  print(paste(Sys.time(), "loading file", shQuote(obj_export[k])))
  export_env <- new.env()
  ftempi <- list.files(dir.dat, pattern = obj_export[k], full.names = TRUE, recursive = TRUE)
  stopifnot(length(ftempi) == 1L)
  load(ftempi, envir = export_env)
  
  # Loop through items of dataset
  items <- ls(envir = export_env)
  print(paste("File", shQuote(obj_export[k]), "contains:", paste(items, collapse = ", ")))

  if (length(items) > 0) for (it in items) {
    # Load item
    print(paste(Sys.time(), "loading data object", shQuote(it)))
    x <- get(it, envir = export_env)
    
    # Decide on dimensions: [study area x] scenarios x models x cells [x response variables]
    d <- dim(x)
    stopifnot(length(d) %in% 3:5)
    id_rastercells <- which(d == ncell)
    has_studyarea <- id_rastercells == 4L
    has_response <- length(d) == id_rastercells + 1L
    if (has_response)
      print(paste("Data object", it, "contains response variables", paste(dimnames(x)[[length(d)]], collapse = ", ")))
    
    # Print out results for all sites
    if (has_studyarea && substr(obj_export[k], 1, 3) == "res" && "Simulation" %in% dimnames(x)[[1]]) {
      x <- if (has_response) x["Simulation", , , , , drop = FALSE] else x["Simulation", , , , drop = FALSE]
    }
    
    # Convert to wide-format
    temp <- reshape2::melt(x)
    wex <- if (has_studyarea) {
        if (has_response) {
          reshape2::dcast(temp, Var4 ~ Var1 + Var2 + Var3 + Var5)
        } else {
          reshape2::dcast(temp, Var4 ~ Var1 + Var2 + Var3)
        }
      } else {
        if (has_response) {
          reshape2::dcast(temp, Var3 ~ Var1 + Var2 + Var4)
        } else {
          reshape2::dcast(temp, Var3 ~ Var1 + Var2)
        }
      }
    names(wex)[1] <- "RasterCell"
    
    # Remove empty columns
    inacol <- apply(wex, 2, function(x) all(is.na(x)))
    if (any(inacol))
      wex <- wex[, !inacol]
      
    # Attach to locations
    wex <- cbind(xy, wex)
    
    # Save to disk
    ftempo <- if (length(items) == 1L) {
        sub(".RData", paste0("_", it, ".csv"), obj_export[k])
      } else {
        sub(".RData", ".csv", obj_export[k])
      }
    write.csv(wex, file = file.path(dir.out_SAM, ftempo), row.names = FALSE)

  }
}
