################### TABULATE AND PLOT SCATTERS AND FITS ##################
#
# Daniel Schlaepfer, 2015-2016
# 
# Tabulate and plot pairwise scatters and smoothed fits of outcomes and/or changes in outcomes
# for temperate dryland areas per region and per simulated cell
# all study_areas_and_shifts x RCP combinations
#	- requests 'get_precalculations' from '5a1_GTD_*.R'
#	- requests 'get_studyareaextents' from '5a1_GTD_*.R'
#
###################################################################

#-------------------------------
#---GLOBAL SETTINGS
comp <- "dropbox"
do_cor <- TRUE
redo_cor <- FALSE

#-------------------------------
#---R packages
pkg_reqd <- c("reshape2", "pcaPP", "RColorBrewer", "digest")
has_loaded <- sapply(pkg_reqd,
	function(lib) require(lib, character.only = TRUE, quietly = FALSE))
stopifnot(has_loaded)

#---Load data and misc. functions
if (comp %in% c("err", "eleos")) {
	dir.gtd <- "/PATH_TO_PROJECT/Product_PowellCenter/6_Projects_Year1"
} else if (comp == "dropbox") {
	dir.gtd <- "/PATH_TO_PROJECT/Product_PowellCenter/6_Projects_Year1"
}
dir.prj <- file.path(dir.gtd, "Prj03_GlobalVulnerability", "4_Analysis", "4_Analysis_v4")


get_precalculations <- TRUE
get_studyareaextents <- TRUE
source(file.path(dir.prj, "5a1_GTD_Prj03v4_Helper.R"))

stopifnot(done_precalculations, done_studyareaextents)


#---Directories
dir.create(dir.out_SAM <- file.path(dir.prj, "6_Results", "10_CorrelationTables_Geographic_v3"), showWarnings = FALSE)
dir.create(dir.fig_SAM <- file.path(dir.out_SAM, "Figures"), showWarnings = FALSE)
dir.create(dir.tab_SAM <- file.path(dir.out_SAM, "Tables"), showWarnings = FALSE)


#-------------------------------
#------Functions

#-------------------------------
#------TABLES AND FIGURES

if (do_cor) {
	res_names <- sets_names_extracted2
	res_labels <- list(label_climate, label_response, label_definition, label_soils, label_veg)	
	type_list_mode <- change_types[1:2]
	
	do_cor_regional_shifted_response_figures <- function(datX_current, datY, datY_current, valY_type, varnameX, varnameY, labelX = varnameX, labelY = varnameY, dir_out, ftagX = varnameX, ftagY = varnameY) {

		ftagX <- clean_name(ftagX)
		ftagY <- clean_name(ftagY)

		# colors
		col_regions <- brewer.pal(5, "Set2")
		colF <- adjustcolor("gray40", alpha.f = 0.4)
		colL <- adjustcolor("black", alpha.f = 0.4)
		icol <- "#FF006080"
		
	
		#------Data
		ydata <- dat_sweep(datY, datY_current["Simulation", currentSc, ], valY_type, circular = grepl("_doy", varnameY))
		
		
		#------Figures
		for (ircp in seq_along(reqRCPs)) {
			# Region medioids
			resx <- numeric(length(regions_n))
			resy <- array(NA, dim = c(length(reqGCMs), length(regions_n), 2), dimnames = list(reqGCMs, regions_n, c("Mean", valY_type)))
			for (i in seq_along(regions_n)) {
				ids <- dLoc[, "Region"] %in% regions_n[i]
				resx[i] <- median(datX_current["MetDef_ThisCond", currentSc, ids], na.rm = TRUE)
				for (igcm in seq_along(reqGCMs)) {
					resy[igcm, i, "Mean"] <- median(datY["MetDef_ThisCond", ircp, igcm, ids], na.rm = TRUE)
					resy[igcm, i, valY_type] <- median(ydata["MetDef_ThisCond", ircp, igcm, ids], na.rm = TRUE)
				}
			}
			resym <- apply(resy[, , valY_type], MARGIN = 2, calc_ensemble4)
			resym2 <- apply(resy[, , "Mean"], MARGIN = 2, calc_ensemble4)

			#------Figure v1: loess smoother + 90% data clouds: overall pooled cells, per GCM, plus among region-medians
			ids <- (dLoc[, "Region"] %in% regions_n)
		
			#Plot
			fname <- paste0("Fig_CorrelationWithCurrent_", reqRCPs[ircp], "_", ftagY, "_", valY_type, "_by_", ftagX, "_v1.pdf")
			if (nchar(fname) >= 255) {
				tempY <- if (nchar(ftagY) <= 50) ftagY else paste0(substr(ftagY, 1, 25), "-", substr(ftagY, 26, 50))
				tempX <- if (nchar(ftagX) <= 50) ftagY else paste0(substr(ftagX, 1, 25), "-", substr(ftagX, 26, 50))
				fname <- paste0("Fig_CorrelationWithCurrent_", reqRCPs[ircp], "_", tempY, "-", digest(ftagY), "_", valY_type, "_by_", tempX, "-", digest(ftagX), "_v1.pdf")
			}
			ftemp <- file.path(dir.fig_SAM, fname)

			if (redo_cor || !file.exists(ftemp)) {
				pdf(height = 4, width = 5, file = ftemp)
				op <- par(mgp = c(1.75, 0.4, 0), mar = c(3, 4, 0.25, 0.25), tcl = 0.3, las = 1, cex = 1)
	
				xlim <- range(datX_current["MetDef_Any17Cond", reqRCPs[ircp], ], na.rm = TRUE)
				ylim <- quantile(ydata["MetDef_Any17Cond", reqRCPs[ircp], , ], probs = c(0.005, 0.995), na.rm = TRUE)
		
				plot(1, col = "white", xlim = xlim, ylim = ylim, xlab = paste0("Current ", labelX), ylab = paste0(if (valY_type == "AbsoluteChange") "Future - current of\n" else if (valY_type == "RelativeChange") "Future / current of\n" else "", labelY), axes = FALSE)
				axis(1)
				axis(2, pos = xlim[1])
				
				# Add 90% data clouds
				for (igcm in seq_along(reqGCMs)) {
					x <- datX_current["MetDef_Any17Cond", reqRCPs[ircp], ids]
					y <- ydata["MetDef_Any17Cond", reqRCPs[ircp], igcm, ids]
			
					try(draw.contourCIpoints(x = x, y = y, alpha = 0.90, col = colF, fill = TRUE, na.rm = TRUE, lwd = 1), silent = TRUE)
				}
		
				#Add lines
				for (igcm in seq_along(reqGCMs)) {
					x <- datX_current["MetDef_Any17Cond", reqRCPs[ircp], ids]
					y <- ydata["MetDef_Any17Cond", reqRCPs[ircp], igcm, ids]

					#xt <- seq(min(x, na.rm = T), max(x, na.rm = T), length.out = 100)
					xt <- seq(quantile(x, probs = 0.025, na.rm = T), quantile(x, probs = 0.975, na.rm = T), length.out = 100)
					y_pred <- predict(loess(y ~ x), newdata = data.frame(x = xt))
			
					lines(xt, y_pred, col = icol, lwd = 2, lend = 1)
				}

				#Add region medians
				for (i in seq_along(regions_n)) {
					arrows(x0 = resx[i], y0 = resym[1, i], y1 = resym[3, i], code = 3, angle = 90, length = 0.1)
					points(resx[i], resym[2, i], pch = 23, cex = 1.5, col = "black", bg = col_regions[i])
				}

				# Legend
				if (!identical(fig_style, "nature")) legend(x = "bottomleft", inset = c(0.05, 0), bty = "n", ncol = 1, pch = 23, legend = label.regions[regions_n], col = "black", pt.bg = col_regions, pt.cex = 1.4, cex = 1, xpd = NA)
				
				# Zero line
				segments(x0 = min(xlim), y0 = 0, x1 = max(xlim), col = "gray20")
		
				par(op)
				dev.off()
			}


			#------Figure v2: loess smoother: per region and per GCM, plus among region-medians
			#Plot
			fname <- paste0("Fig_CorrelationWithCurrent_", reqRCPs[ircp], "_", ftagY, "_", valY_type, "_by_", ftagX, "_v2.pdf")
			if (nchar(fname) >= 255) {
				tempY <- if (nchar(ftagY) <= 50) ftagY else paste0(substr(ftagY, 1, 25), "-", substr(ftagY, 26, 50))
				tempX <- if (nchar(ftagX) <= 50) ftagY else paste0(substr(ftagX, 1, 25), "-", substr(ftagX, 26, 50))
				fname <- paste0("Fig_CorrelationWithCurrent_", reqRCPs[ircp], "_", tempY, "-", digest(ftagY), "_", valY_type, "_by_", tempX, "-", digest(ftagX), "_v2.pdf")
			}
			ftemp <- file.path(dir.fig_SAM, fname)
			if (redo_cor || !file.exists(ftemp)) {
				pdf(height = 4, width = 5, file = ftemp)
				op <- par(mgp = c(1.75, 0.4, 0), mar = c(3, 4, 0.25, 0.25), tcl = 0.3, las = 1, cex = 1)
	
				xlim <- range(datX_current["MetDef_Any17Cond", reqRCPs[ircp], ], na.rm = TRUE)
				ylim <- quantile(ydata["MetDef_Any17Cond", reqRCPs[ircp], , ], probs = c(0.005, 0.995), na.rm = TRUE)
		
				plot(1, col = "white", xlim = xlim, ylim = ylim, xlab = paste0("Current ", labelX), ylab = paste0(if (valY_type == "AbsoluteChange") "Future - current of\n" else if (valY_type == "RelativeChange") "Future / current of\n" else "", labelY), axes = FALSE)
				axis(1)
				axis(2, pos = xlim[1])
				
		
				# Add 90% data clouds
				for (igcm in seq_along(reqGCMs)) {
					for (i in seq_along(regions_n)) {
						ids <- dLoc[, "Region"] %in% regions_n[i]
						x <- datX_current["MetDef_Any17Cond", reqRCPs[ircp], ids]
						y <- ydata["MetDef_Any17Cond", reqRCPs[ircp], igcm, ids]
			
						try(draw.contourCIpoints(x = x, y = y, alpha = 0.90, col = adjustcolor(col_regions[i], alpha.f = 1/16), fill = TRUE, na.rm = TRUE, lwd = 3), silent = TRUE)
					}
				}
					
				#Add lines
				for (i in seq_along(regions_n)) {
					ids <- dLoc[, "Region"] %in% regions_n[i]
					for (igcm in seq_along(reqGCMs)) {
						x <- datX_current["MetDef_Any17Cond", reqRCPs[ircp], ids]
						y <- ydata["MetDef_Any17Cond", reqRCPs[ircp], igcm, ids]

						#xt <- seq(min(x, na.rm = T), max(x, na.rm = T), length.out = 100)
						xt <- seq(quantile(x, probs = 0.025, na.rm = T), quantile(x, probs = 0.975, na.rm = T), length.out = 100)
						y_pred <- predict(loess(y ~ x), newdata = data.frame(x = xt))
			
						lines(xt, y_pred, col = col_regions[i], lwd = 2, lend = 1)
					}
				}
				
				#Add region medians
				for (i in seq_along(regions_n)) {
					arrows(x0 = resx[i], y0 = resym[1, i], y1 = resym[3, i], code = 3, angle = 90, length = 0.1)
					points(resx[i], resym[2, i], pch = 23, cex = 1.5, col = "black", bg = col_regions[i])
				}
				
				#Add region line
#				xt <- seq(min(resx), max(resx), length.out = 100)
#				y_pred <- predict(loess(resy[2, ] ~ resx, span = 1), newdata = data.frame(resx = xt))
#				lines(xt, y_pred, col = "black", lwd = 3, lend = 1)
				
				# Zero line
				segments(x0 = min(xlim), y0 = 0, x1 = max(xlim), col = "gray20")
				
				# Legend
				if (!identical(fig_style, "nature")) legend(x = "bottomleft", inset = c(0.05, 0), bty = "n", ncol = 1, pch = 15, legend = label.regions[regions_n], col = col_regions, pt.cex = 1.4, cex = 1, xpd = NA)
		
				par(op)
				dev.off()
			}
		}		

		invisible(NULL)
	}

	do_cor_regional_shifted_response_table <- function(datX_current, datY, datY_current, method = c("spearman", "pearson", "kendall", "calc_fast_tau"), valY_type, varnameX, varnameY, labelX = varnameX, labelY = varnameY, dir_out, ftagX = varnameX, ftagY = varnameY) {

		method <- match.arg(method)
		ftagX <- clean_name(ftagX)
		ftagY <- clean_name(ftagY)
		
	
		#------Data
		ydata <- dat_sweep(datY, datY_current["Simulation", currentSc, ], valY_type, circular = grepl("_doy", varnameY))
		
		
		#------Tables
		fname <- paste0("Table_CorrelationWithCurrent_", ftagY, "_", valY_type, "_by_", ftagX, "_", method, ".csv")
		if (nchar(fname) >= 255) {
			tempY <- if (nchar(ftagY) <= 50) ftagY else paste0(substr(ftagY, 1, 25), "-", substr(ftagY, 26, 50))
			tempX <- if (nchar(ftagX) <= 50) ftagY else paste0(substr(ftagX, 1, 25), "-", substr(ftagX, 26, 50))
			fname <- paste0("Table_CorrelationWithCurrent_", tempY, "-", digest(ftagY), "_", valY_type, "_by_", tempX, "-", digest(ftagX), "_", method, ".csv")
		}
		ftemp <- file.path(dir.tab_SAM, fname)
		
		if (redo_cor || !file.exists(ftemp)) {
			#---Prepare correlation table
			#---Individual scenarios
			res <- array(NA, dim = c(2 + length(regions_n), length(reqRCPs), length(reqGCMs)), dimnames = list(c("CorAmongRegionMedians", "CorAmongAllCells", label.regions[regions_n]), reqRCPs, reqGCMs))
			
			#RCPs x GCMs x regions
			for (ircp in seq_along(reqRCPs)) for (igcm in seq_along(reqGCMs)) for (i in c(-1, 0, seq_along(regions_n))) {
				if (i == -1) { #CorAmongRegionMedians
					x <- tapply(datX_current["MetDef_Any17Cond", reqRCPs[ircp], ], INDEX = dLoc[, "Region"], median, na.rm = TRUE)[regions_n]
					y <- tapply(ydata["MetDef_Any17Cond", reqRCPs[ircp], igcm, ], INDEX = dLoc[, "Region"], median, na.rm = TRUE)[regions_n]
			
					if (method %in% c("pearson", "kendall", "spearman")) {
						res[1, ircp, igcm] <- cor(x = x, y = y, use = "pairwise.complete.obs", method = method)
					} else if (method == "calc_fast_tau") {
						res[1, ircp, igcm] <- calc_fast_tau(x = x, y = y)
					}
				} else {
					ids <- if (i > 0) (dLoc[, "Region"] %in% regions_n[i]) else (dLoc[, "Region"] %in% regions_n)

					x <- datX_current["MetDef_Any17Cond", reqRCPs[ircp], ids]
					y <- ydata["MetDef_Any17Cond", reqRCPs[ircp], igcm, ids]
			
					if (method %in% c("pearson", "kendall", "spearman")) {
						res[2 + i, ircp, igcm] <- cor(x = x, y = y, use = "pairwise.complete.obs", method = method)
					} else if (method == "calc_fast_tau") {
						res[2 + i, ircp, igcm] <- calc_fast_tau(x = x, y = y)
					}
				}
			}
			
			
			#---Aggregated to ranks
			res2 <- array(NA, dim = c(2 + length(regions_n), length(reqRCPs), length(ranks)), dimnames = list(c("CorAmongRegionMedians", "CorAmongAllCells", label.regions[regions_n]), reqRCPs, paste0("Rank", ranks)))
			
			for (i in 1:dim(res)[[1]]) for (ircp in seq_along(reqRCPs))
				res2[i, ircp, ] <- calc_ensemble4(res[i, ircp, ])
			
			
			#---Prepare table
			temp <- melt(res2)
			resT <- dcast(temp, Var2 + Var3 ~ Var1)
			
			#---Format table
			resOut <- resT
			for (iv in 1:ncol(resOut)) {
				if (inherits(resOut[, iv], "numeric")) {
					resOut[, iv] <- as.character(round(resOut[, iv], 2))
					resOut[, iv] <- ifelse(is.na(resOut[, iv]), "", resOut[, iv])
					
					resOut[(resOut$Var3 == "Rank16"), iv] <- ifelse(resOut[(resOut$Var3 == "Rank8"), iv] == "", "", paste0("(", resOut[(resOut$Var3 == "Rank1"), iv], ", ", resOut[(resOut$Var3 == "Rank16"), iv], ")"))
				}
				if (is.factor(resOut[, iv])) resOut[, iv] <- as.character(resOut[, iv])
			}
			resOut <- resOut[!(resOut$Var3 == "Rank1"), ]
			resOut[(resOut$Var3 == "Rank8"), "Var3"] <- "mid"
			resOut[(resOut$Var3 == "Rank16"), "Var3"] <- "(lo, hi)"

			write.csv(resOut, file = ftemp)
		}		

		invisible(NULL)
	}



	print("DrylandResponse: regional correlation tables against current conditions")
		
	# get data objects
	scatter_list <- list(list(idx = 1, idy = 1, ivx = 2, ivy = 1), #MAP vs MAT
						list(idx = 1, idy = 1, ivx = 4, ivy = 1), #MAP vs Seasonality
						list(idx = 1, idy = 2, ivx = 1, ivy = 8), #TranspirationBottomToTranspirationTotal_fraction vs MAP
						list(idx = 1, idy = 2, ivx = 4, ivy = 8), #TranspirationBottomToTranspirationTotal_fraction vs Seasonality
						list(idx = 2, idy = 2, ivx = 8, ivy = 8), #TranspirationBottomToTranspirationTotal_fraction vs TranspirationBottomToTranspirationTotal_fraction
						list(idx = 2, idy = 2, ivx = 1, ivy = 2)	#ThermalSnowfreeDryPeriods_SWPcrit3000kPa_bottomLayers_DrySpellsAllLayers_maxDuration_days vs ThermalSnowfreeDryPeriods_SWPcrit3000kPa_topLayers_DrySpellsAllLayers_maxDuration_days
					)
	
	for (ils in scatter_list) {
		temp <- get(res_names[ils$idx])
		varsX <- dimnames(temp)[[5]]
		dataX_current <- temp[study_areas_all, , currentSc, , ]
		temp <- get(res_names[ils$idy])
		varsY <- dimnames(temp)[[5]]
		dataY <- temp[, -1, -1, , ]
		dataY_current <- temp[study_areas_all, , currentSc, , ]
	
	
		for (ity in seq_along(type_list_mode)) {

			print(paste(Sys.time(), res_names[ils$idx], res_names[ils$idy], varsX[ils$ivx], varsY[ils$ivy], type_list_mode[ity]))
			do_cor_regional_shifted_response_figures(datX_current = dataX_current[, , , varsX[ils$ivx]], 
													datY = dataY[, , , , varsY[ils$ivy]], datY_current = dataY_current[, , , varsY[ils$ivy]],
													valY_type = type_list_mode[ity],
													varnameX = varsX[ils$ivx], varnameY = varsY[ils$ivy],
													labelX = res_labels[[ils$idx]][ils$ivx], labelY = res_labels[[ils$idy]][ils$ivy], 
													dir_out = dir.out_SAM)

			for (method in c("pearson", "spearman", "calc_fast_tau")) {

				do_cor_regional_shifted_response_table(datX_current = dataX_current[, , , varsX[ils$ivx]], 
													datY = dataY[, , , , varsY[ils$ivy]], datY_current = dataY_current[, , , varsY[ils$ivy]],
													method = method, valY_type = type_list_mode[ity],
													varnameX = varsX[ils$ivx], varnameY = varsY[ils$ivy],
													labelX = res_labels[[ils$idx]][ils$ivx], labelY = res_labels[[ils$idy]][ils$ivy], 
													dir_out = dir.out_SAM)
			}
		}
	}
	
}

